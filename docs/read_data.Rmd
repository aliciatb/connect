---
title: "Read Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(httr)
library(jsonlite)
library(readr)
library(RSocrata)
library(stringr)
```
## RSocrata

RSocrata is a library created by the City of Chicago to enable reading, writing and discovering data.

- Read a Socrata dataset
- We can use the full URL

### Fish Species in Michigan

- Source: https://data.michigan.gov/Environment/Michigan-Fish/he9h-7fpa
- Since this is a public dataset, we don't need to pass user name, password or app token
- Inspect first 5 rows of data with shortened narrative

```{r rSocrataExample, echo=TRUE}
url <- "https://data.michigan.gov/Environment/Michigan-Fish/he9h-7fpa"
rsocrata_data <- read.socrata(url, stringsAsFactors = TRUE)

# use dplyr to select top 5 records of the 3 first fields and use stringr to shorten Narrative to 50 characters
rsocrata_data %>%
  mutate(ShortNarrative = str_replace(Narrative,'Identifying characteristics: ','')) %>%
  mutate(ShortNarrative = str_sub(ShortNarrative,0,50)) %>%
  select(CommonName, LatinName, ShortNarrative) %>%
  top_n(5)
```

### Stellar Sea Lion Count

- For private datasets, you do need to include user name and password.
- You can also create an API Key now on Socrata and pass the Key Id and Key Secret as user name and password respectively

***Not really a private dataset, but made private for this example***

```{r SocrataExampleAuth, echo=T}
url <- "https://alicia.data.socrata.com/dataset/2016-Counts-of-Steller-Sea-Lions/td26-kbwz"

email <- Sys.getenv("MY_SOCRATA_USERNAME")
password <- Sys.getenv("MY_SOCRATA_PASSWORD")
rsocrata_data <- read.socrata(url, app_token = NULL, email = email, password = password, stringsAsFactors = TRUE)
head(rsocrata_data)
```

## Readr

- Can read public datasets using the CSV endpoint (which returns all of the data!)
- Preserves field names (rather than replacing spaces with periods)
- Fast!
- Returns as Tibble (part of the tidyverse!)

### Dallas Rain Sensor Data

```{r rReadrExample, echo=TRUE}
# public dataset example requiring no authentication
readr_data <- read_csv("https://www.dallasopendata.com/api/views/jus4-wys9/rows.csv?accessType=DOWNLOAD")
head(readr_data)
```


## httr + jsonlite + soda2

- R supports all HTTP requests methods
- JSONLite makes it easy to work with JSON source
- Use the SODA2 endpoint (which defaults to 1,000 records, but can get rowcount and then set limit to itd)

```{r rHttrJsonExample, echo=TRUE, eval=T, error=F}
## HTTR + JSONLite + SODA2 Endpoint

# >- Defaults to 1,000 records so need to query rowcount from https://data.seattle.gov/resource/28ny-9ts8.json?$select=count(*) or request reasonably large number of rows https://data.seattle.gov/resource/28ny-9ts8.json?$limit=50000 for full dataset

url_soda2_json <- "https://data.seattle.gov/resource/28ny-9ts8.json?$limit=50000"
socrata_user <- Sys.getenv("MY_SOCRATA_USERNAME")
socrata_password <- Sys.getenv("MY_SOCRATA_PASSWORD")

response <- GET(url = url_soda2_json,
                      config = authenticate(socrata_user,socrata_password, type = "basic")
                ) %>% 
            content("text") %>% 
            fromJSON()

head(response)
```
