---
title: "Read Data"
output: html_document
---

```{r setup, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE,warning = FALSE)
library(dplyr)
library(httr)
library(jsonlite)
library(kableExtra)
library(knitr)
library(readr)
library(RSocrata)
```
## RSocrata

[RSocrata](https://github.com/Chicago/RSocrata) is a library created by the City of Chicago to enable reading, writing and discovering data.

- Read a Socrata dataset
- We can use the full URL

### Fish Species in Michigan

- Source: https://data.michigan.gov/Environment/Michigan-Fish/he9h-7fpa
- Since this is a public dataset, we don't need to pass user name, password or app token
- We can even display the image URL as an image

```{r rSocrataExample}
url <- "https://data.michigan.gov/Environment/Michigan-Fish/he9h-7fpa"
rsocrata_data <- read.socrata(url)

rsocrata_data %>%
  top_n(10, CommonName) %>%
  mutate(Image = paste0("<image src='",Image,"'></image>")) %>%
  # setting escape to FALSE allows html to be rendered for the fish images!
  kable(escape = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  kableExtra::scroll_box(width = "900px", height = "300px")
```

### Stellar Sea Lion Count

- For private datasets, you do need to include user name and password.
- You can also create an API Key now on Socrata and pass the Key Id and Key Secret as user name and password respectively

***Not really a private dataset, but made private for this example***

```{r SocrataExampleAuth}
url <- "https://alicia.data.socrata.com/Species/2016-Counts-of-Steller-Sea-Lions-Pups-Adults-and-J/qaj3-k28x"

email <- Sys.getenv("MY_SOCRATA_USERNAME")
password <- Sys.getenv("MY_SOCRATA_PASSWORD")
rsocrata_data <- read.socrata(url, app_token = NULL, email = email, password = password, stringsAsFactors = TRUE)

rsocrata_data %>%
  top_n(10, Site.Name) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  kableExtra::scroll_box(width = "900px", height = "300px")
```

## Readr

- Can read public datasets using the CSV endpoint (which returns all of the data!)
- Preserves field names (rather than replacing spaces with periods)
- Fast!
- Returns as Tibble (part of the tidyverse!)

### Dallas Rain Sensor Data

```{r rReadrExample}
# public dataset example requiring no authentication
readr_data <- read_csv("https://www.dallasopendata.com/api/views/jus4-wys9/rows.csv?accessType=DOWNLOAD")

readr_data %>%
  top_n(10, sensor_id) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  kableExtra::scroll_box(width = "900px", height = "300px")
```

## httr + jsonlite + soda2

- R supports all HTTP requests methods
- JSONLite makes it easy to work with JSON source
- Use the SODA2 endpoint (which defaults to 1,000 records, but can get rowcount and then set limit to itd)
- Read the Texas Registered Boats dataset with 650K records

```{r rHttrJsonExample}
## HTTR + JSONLite + SODA2 Endpoint

# >- Defaults to 1,000 records so need to query rowcount from https://data.seattle.gov/resource/28ny-9ts8.json?$select=count(*) or request reasonably large number of rows https://data.seattle.gov/resource/28ny-9ts8.json?$limit=50000 for full dataset

url_soda2_json <- "https://data.texas.gov/resource/5cwn-bm88.json?$limit=660000"
socrata_user <- Sys.getenv("MY_SOCRATA_USERNAME")
socrata_password <- Sys.getenv("MY_SOCRATA_PASSWORD")

response <- GET(url = url_soda2_json,
                      config = authenticate(socrata_user,socrata_password, type = "basic")
                ) %>% 
            content("text") %>% 
            fromJSON()

response %>%
  select(tx_number, year_built, make, model, engine_type, fuel_description, propulsion, vessel_type, vessel_use, city, county_name) %>%
  top_n(10, tx_number) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  kableExtra::scroll_box(width = "900px", height = "300px")
```
